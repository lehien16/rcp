<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√≠ ng∆∞·ªùi d√πng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/feather-icons"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        }
                    }
                }
            }
        }
    </script>

</head>

<body class="bg-gray-50">
<div class="flex h-screen">
    
    <!-- Sidebar -->
    <div id="shared-sidebar" class="w-65"></div>

    <div class="flex-1 overflow-auto">
        <!-- Header -->
        <div id="shared-header"></div>

            <main class="p-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 border-b pb-4">Qu·∫£n l√≠ ng∆∞·ªùi d√πng</h1>

                <!-- ====== CARDS TH·ªêNG K√ä USER ====== -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

                <!-- T·ªïng ng∆∞·ªùi d√πng -->
                <div class="rounded-xl shadow-md p-6 border border-white/40
                    bg-[linear-gradient(135deg,rgba(255,215,186,0.45),rgba(255,255,255,0.7),rgba(244,196,113,0.45))] 
                    hover:shadow-xl hover:scale-[1.02] transition-all duration-300">

                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xl font-bold text-gray-500">T·ªïng ng∆∞·ªùi d√πng</p>
                            <p class="text-2xl font-bold mt-2 text-gray-800">324</p>
                        </div>

                        <div class="bg-yellow-50 text-yellow-600 p-3 rounded-lg">
                            <i data-feather="users" class="text-3xl"></i>
                        </div>
                    </div>

                </div>

                <!-- Admin -->
                <div class="rounded-xl shadow-md p-6 border border-white/40
                    bg-[linear-gradient(135deg,#FFF8EB,#FFDF9E,#F2C15F)]
                    hover:shadow-xl hover:scale-[1.02] transition-all duration-300">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xl font-bold text-gray-500">Qu·∫£n tr·ªã vi√™n</p>
                            <p class="text-2xl font-bold text-gray-800 mt-2">5</p>
                        </div>
                        <div class="bg-purple-50 text-purple-600 p-3 rounded-lg">
                            <i data-feather="shield" class="text-3xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Kh√°ch h√†ng -->
                <div class="rounded-xl shadow-md p-6 border border-white/40
                    bg-[linear-gradient(135deg,#FFF6E3,#FFE2A8,#FFCD6A)]
                    hover:shadow-xl hover:scale-[1.02] transition-all duration-300">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-xl font-bold text-gray-500">Kh√°ch h√†ng</p>
                            <p class="text-2xl font-bold text-gray-800 mt-2">298</p>
                        </div>
                        <div class="bg-blue-50 text-green-600 p-3 rounded-lg">
                            <i data-feather="user" class="text-3xl"></i>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ====== B·∫¢NG NG∆Ø·ªúI D√ôNG ====== -->
            <div class="bg-slate-50 rounded-xl shadow-lg border-2 border-slate-300 ring-1 ring-slate-200 p-6">


                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">Danh s√°ch ng∆∞·ªùi d√πng</h2>
                        <button onclick="console.log('Button clicked'); openAdd();"
                            class="px-5 py-2.5 rounded-lg font-semibold
                            bg-white/60 backdrop-blur
                            border border-amber-200/60
                            text-amber-700 shadow-sm
                            hover:bg-amber-100/70 hover:shadow-md">
                            <i class="fa fa-plus mr-1"></i>Th√™m ng∆∞·ªùi d√πng
                        </button>
                </div>

                <div class="max-h-[420px] overflow-y-auto overflow-x-auto rounded-lg">
                    <table class="min-w-[1600px] table-fixed bg-white border-2 border-slate-300 rounded-xl overflow-hidden" style="white-space: nowrap;">
                    <thead class="bg-gradient-to-r from-[#FFF3C4] via-[#F5D77A] to-[#EAC35B]
              sticky top-0 z-10 shadow-md">

                        <tr>
                            <th class="px-4 py-3 w-[100px] text-nowrap">M√£ ND</th>
                            <th class="px-4 py-3 w-[180px] text-nowrap">H·ªç T√™n</th>
                            <th class="px-4 py-3 w-[240px] text-nowrap">Email</th>
                            <th class="px-4 py-3 w-[140px] text-center text-nowrap">SƒêT</th>
                            <th class="px-4 py-3 w-[140px] text-center text-nowrap">Ng√†y Sinh</th>
                            <th class="px-4 py-3 w-[160px] text-nowrap">Th√†nh Ph·ªë</th>
                            <th class="px-4 py-3 w-[160px] text-nowrap">T√™n ƒêN</th>
                            <th class="px-4 py-3 w-[120px] text-center text-nowrap">M·∫≠t Kh·∫©u</th>
                            <th class="px-4 py-3 w-[160px] text-center text-nowrap">Quy·ªÅn h·∫°n</th>
                            <th class="px-4 py-3 w-[120px] text-center text-nowrap">Avatar</th>
                            <th class="px-4 py-3 w-[140px] text-center text-nowrap">Ng√†y T·∫°o</th>
                            <th class="px-4 py-3 w-[160px] text-center text-nowrap">H√†nh ƒë·ªông</th>

                        </tr>
                    </thead>


                    <tbody id="userTable" class="divide-y divide-gray-100 bg-white"></tbody>
                </table>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- MODAL -->
<div id="userModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg w-[600px] p-6 relative z-50">

        <h3 id="modalTitle" class="text-lg font-semibold mb-4"></h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div>
                <label class="text-sm font-medium">
                    M√£ ng∆∞·ªùi d√πng
                </label>
                <input id="MaND" class="border p-2 rounded w-full bg-gray-100" readonly placeholder="T·ª± ƒë·ªông t·∫°o">
            </div>

            <div>
                <label class="text-sm font-medium">
                    H·ªç t√™n <span class="text-red-500">*</span>
                </label>
                <input id="HoTen" class="border p-2 rounded w-full">
            </div>

            <div>
                <label class="text-sm font-medium">
                    Email <span class="text-red-500">*</span>
                </label>
                <input id="Email" class="border p-2 rounded w-full">
            </div>

            <div>
                <label class="text-sm font-medium">
                    SƒêT <span class="text-red-500">*</span>
                </label>
                <input
                    id="SoDT"
                    class="border p-2 rounded w-full"
                    type="tel"
                    maxlength="10"
                    oninput="limitPhone(this)"
                    placeholder="0xxxxxxxxx">

            </div>

            <div>
                <label class="text-sm font-medium">
                    Ng√†y sinh <span class="text-red-500">*</span>
                </label>
                <input id="NgaySinh" type="date" class="border p-2 rounded w-full">
            </div>

            <div>
                <label class="text-sm font-medium">
                    Th√†nh ph·ªë <span class="text-red-500">*</span>
                </label>
                <select id="ThanhPho" class="border p-2 rounded w-full">
                    <option value="">-- Ch·ªçn th√†nh ph·ªë --</option>
                    <option value="H√† N·ªôi">H√† N·ªôi</option>
                    <option value="TP.HCM">TP. H·ªì Ch√≠ Minh</option>
                    <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                    <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                    <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                    <option value="Hu·∫ø">Hu·∫ø</option>
                    <option value="Nha Trang">Nha Trang</option>
                    <option value="V≈©ng T√†u">V≈©ng T√†u</option>
                    <option value="Quy Nhon">Quy Nhon</option>
                    <option value="Pleiku">Pleiku</option>
                    <option value="Bu√¥n Ma Thu·ªôt">Bu√¥n Ma Thu·ªôt</option>
                    <option value="ƒê√† L·∫°t">ƒê√† L·∫°t</option>
                    <option value="Phan Thi·∫øt">Phan Thi·∫øt</option>
                    <option value="Long Xuy√™n">Long Xuy√™n</option>
                    <option value="R·∫°ch Gi√°">R·∫°ch Gi√°</option>
                    <option value="C√† Mau">C√† Mau</option>
                    <option value="Vinh">Vinh</option>
                    <option value="Thanh H√≥a">Thanh H√≥a</option>
                    <option value="Nam ƒê·ªãnh">Nam ƒê·ªãnh</option>
                    <option value="Th√°i Nguy√™n">Th√°i Nguy√™n</option>
                </select>
            </div>

            <div>
                <label class="text-sm font-medium">
                    T√™n ƒëƒÉng nh·∫≠p <span class="text-red-500">*</span>
                </label>
                <input id="TenDN" class="border p-2 rounded w-full">
            </div>

            <div id="currentPasswordDiv" class="hidden">
                <label class="text-sm font-medium">
                    M·∫≠t kh·∫©u hi·ªán t·∫°i <span class="text-red-500">*</span>
                </label>
                <input id="MatKhauHienTai" type="password" class="border p-2 rounded w-full" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i ƒë·ªÉ x√°c nh·∫≠n">
            </div>

            <div>
                <label class="text-sm font-medium">
                    <span id="passwordLabel">M·∫≠t kh·∫©u <span class="text-red-500">*</span></span>
                </label>
                <input id="MatKhau" type="password" class="border p-2 rounded w-full" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            </div>

            <div>
                <label class="text-sm font-medium">
                    Quy·ªÅn h·∫°n <span class="text-red-500">*</span>
                </label>
                <select id="QuyenHan" class="border p-2 rounded w-full">
                    <option value="">-- Ch·ªçn quy·ªÅn h·∫°n --</option>
                    <option value="Kh√°ch h√†ng">üë§ Kh√°ch h√†ng</option>
                    <option value="Qu·∫£n tr·ªã vi√™n">üõ°Ô∏è Qu·∫£n tr·ªã vi√™n</option>
                </select>
            </div>

            <div>
                <label class="text-sm font-medium">
                    Avatar
                </label>
                <div class="space-y-2">
                    <input type="file" id="AvatarFile" accept="image/*" class="border p-2 rounded w-full" onchange="previewAvatar(this)">
                    <input id="Avatar" type="hidden">
                    <div id="avatarPreview" class="hidden">
                        <img id="previewImg" class="w-20 h-20 rounded-full object-cover border-2 border-gray-300" alt="Avatar preview">
                        <button type="button" onclick="removeAvatar()" class="text-red-500 text-sm mt-1">X√≥a ·∫£nh</button>
                    </div>
                </div>
            </div>

        </div>

        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeModal()" class="px-4 py-2 border rounded hover:bg-gray-50">H·ªßy</button>
            <button onclick="saveUser()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">L∆∞u</button>
        </div>
    </div>
</div>
<script>
fetch("../api/user/get_users.php")
    .then(response => {
        console.log("Response status:", response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    
    .then(users => {
        console.log("D·ªØ li·ªáu t·ª´ b·∫£ng NguoiDung:", users);
        window.users = users;
        
        const tbody = document.getElementById("userTable");
        tbody.innerHTML = "";

        if (users.error) {
            tbody.innerHTML = `<tr><td colspan="11" class="px-6 py-4 text-center text-red-500">L·ªói database: ${users.error}</td></tr>`;
            return;
        }

        if (!Array.isArray(users) || users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="11" class="px-6 py-4 text-center text-gray-500">B·∫£ng NguoiDung kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
            return;
        }

        const totalUsers = users.length;
        const admins = users.filter(u => u.QuyenHan === 'Qu·∫£n tr·ªã vi√™n').length;
        const customers = users.filter(u => u.QuyenHan === 'Kh√°ch h√†ng').length;
        
        document.querySelector('.grid > div:nth-child(1) .text-2xl').textContent = totalUsers;
        document.querySelector('.grid > div:nth-child(2) .text-2xl').textContent = admins;
        document.querySelector('.grid > div:nth-child(3) .text-2xl').textContent = customers;

        users.forEach((user, index) => {
            const row = `
            <tr class="odd:bg-white even:bg-slate-50 hover:bg-blue-50 transition">
                <td class="px-4 py-3 text-sm font-medium text-nowrap">${user.MaND}</td>
                <td class="px-4 py-3 text-sm font-semibold text-nowrap">${user.HoTen}</td>
                <td class="px-4 py-3 text-sm text-blue-600 text-nowrap overflow-hidden text-ellipsis" title="${user.Email}">${user.Email}</td>
                <td class="px-4 py-3 text-sm text-center text-nowrap">${user.SoDT || 'Ch∆∞a c√≥'}</td>
                <td class="px-4 py-3 text-sm text-center text-nowrap">${user.NgaySinh || ''}</td>
                <td class="px-4 py-3 text-sm text-nowrap">${user.ThanhPho || ''}</td>
                <td class="px-4 py-3 text-sm text-nowrap">${user.TenDN}</td>
                <td class="px-4 py-3 text-sm text-center text-nowrap">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                <td class="px-4 py-3 text-sm text-center text-nowrap">
                    <span class="px-3 py-1 text-xs rounded-full font-medium whitespace-nowrap
                        ${(user.QuyenHan === 'Qu·∫£n tr·ªã vi√™n')
                            ? 'bg-red-100 text-red-700 border border-red-200'
                            : 'bg-blue-100 text-blue-700 border border-blue-200'}">
                        ${(user.QuyenHan === 'Qu·∫£n tr·ªã vi√™n') 
                            ? 'üõ°Ô∏è Qu·∫£n tr·ªã vi√™n' 
                            : 'üë§ Kh√°ch h√†ng'}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-center text-nowrap">
                    <div class="w-8 h-8 mx-auto rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                        ${user.Avatar ? 
                            `<img src="${user.Avatar}" class="w-full h-full object-cover" alt="Avatar">` :
                            `<i class="fa fa-user text-gray-500 text-sm"></i>`
                        }
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-center text-nowrap">${user.NgayTao}</td>
                <td class="px-4 py-3 text-sm text-center text-nowrap">
                    <div class="flex justify-center items-center gap-2 whitespace-nowrap">
                        <button onclick="openEdit(${index})"
                            class="px-3 py-1 text-xs rounded bg-blue-500 text-white hover:bg-blue-600">
                            S·ª≠a
                        </button>
                        <button onclick="deleteUser(${index})"
                            class="px-3 py-1 text-xs rounded bg-red-500 text-white hover:bg-red-600">
                            X√≥a
                        </button>
                    </div>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        feather.replace();
    })
    
    .catch(error => {
        console.error("L·ªói k·∫øt n·ªëi database:", error);
        const tbody = document.getElementById("userTable");
        tbody.innerHTML = `
        <tr>
            <td colspan="11" class="px-6 py-4 text-center text-red-500">
                ‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi database<br>
                <small>L·ªói: ${error.message}</small><br>
                <small>H√£y ƒë·∫£m b·∫£o: 1) MySQL ƒëang ch·∫°y 2) Database 'qlynguoidung' t·ªìn t·∫°i 3) M·ªü qua web server</small>
            </td>
        </tr>`;
    });
</script>

<script>
    let mode = "add";
    let editIndex = null;
    
    function applyFeather() {
        feather.replace();
    }



    /* ===== MODAL ===== */
    function openAdd() {
        mode = "add";
        editIndex = null;
        document.getElementById("modalTitle").innerText = "Th√™m ng∆∞·ªùi d√πng";
        clearForm();
        
        // ·∫®n tr∆∞·ªùng m·∫≠t kh·∫©u hi·ªán t·∫°i khi th√™m m·ªõi
        document.getElementById('currentPasswordDiv').classList.add('hidden');
        document.getElementById('passwordLabel').innerHTML = 'M·∫≠t kh·∫©u <span class="text-red-500">*</span>';
        document.getElementById('MatKhau').placeholder = 'Nh·∫≠p m·∫≠t kh·∫©u';
        
        // T·ª± ƒë·ªông t·∫°o m√£ ng∆∞·ªùi d√πng m·ªõi
        generateNewUserCode();
        
        showModal();
    }
    
    function generateNewUserCode() {
        let newId = 1;
        
        if (window.users && window.users.length > 0) {
            // T√¨m t·∫•t c·∫£ c√°c s·ªë ID hi·ªán c√≥
            const existingIds = window.users.map(u => {
                const match = u.MaND.match(/ND(\d+)/);
                return match ? parseInt(match[1]) : 0;
            }).filter(id => id > 0);
            
            // T√¨m ID l·ªõn nh·∫•t v√† tƒÉng l√™n 1
            if (existingIds.length > 0) {
                newId = Math.max(...existingIds) + 1;
            }
        }
        
        // T·∫°o m√£ m·ªõi v·ªõi format ND + 3 ch·ªØ s·ªë
        const newCode = 'ND' + String(newId).padStart(3, '0');
        document.getElementById('MaND').value = newCode;
        
        console.log('Generated new user code:', newCode);
    }

    function openEdit(index) {
        mode = "edit";
        editIndex = index;
        document.getElementById("modalTitle").innerText = "S·ª≠a ng∆∞·ªùi d√πng";

        const u = window.users[index];
        document.getElementById('MaND').value = u.MaND;
        document.getElementById('HoTen').value = u.HoTen;
        document.getElementById('Email').value = u.Email;
        document.getElementById('SoDT').value = u.SoDT;
        document.getElementById('NgaySinh').value = u.NgaySinh;
        document.getElementById('ThanhPho').value = u.ThanhPho;
        document.getElementById('TenDN').value = u.TenDN;
        document.getElementById('QuyenHan').value = u.QuyenHan;
        
        // Hi·ªÉn th·ªã tr∆∞·ªùng m·∫≠t kh·∫©u hi·ªán t·∫°i khi s·ª≠a
        document.getElementById('currentPasswordDiv').classList.remove('hidden');
        document.getElementById('passwordLabel').innerHTML = 'M·∫≠t kh·∫©u m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)';
        document.getElementById('MatKhauHienTai').value = '';
        document.getElementById('MatKhau').value = '';
        document.getElementById('MatKhau').placeholder = 'ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi m·∫≠t kh·∫©u';
        
        // Hi·ªÉn th·ªã avatar c√≥ s·∫µn
        showExistingAvatar(u.Avatar);

        showModal();
    }

        async function saveUser() {
            const data = {
                MaND: document.getElementById('MaND').value.trim(),
                HoTen: document.getElementById('HoTen').value.trim(),
                Email: document.getElementById('Email').value.trim(),
                SoDT: document.getElementById('SoDT').value.trim(),
                NgaySinh: document.getElementById('NgaySinh').value.trim(),
                ThanhPho: document.getElementById('ThanhPho').value.trim(),
                TenDN: document.getElementById('TenDN').value.trim(),
                QuyenHan: document.getElementById('QuyenHan').value.trim(),
                Avatar: document.getElementById('Avatar').value.trim(),
                MatKhau: document.getElementById('MatKhau').value.trim(),
                MatKhauHienTai: document.getElementById('MatKhauHienTai').value.trim()
            };

            // Debug: In ra d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra
            console.log('Mode:', mode);
            console.log('Data being sent:', data);
            
            // Validate d·ªØ li·ªáu
            if (!data.MaND || !data.HoTen || !data.Email || !data.TenDN || !data.ThanhPho || !data.QuyenHan) {
                alert("‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc:\n" +
                      "- M√£ ND: " + (data.MaND ? "‚úì" : "‚úó") + "\n" +
                      "- H·ªç t√™n: " + (data.HoTen ? "‚úì" : "‚úó") + "\n" +
                      "- Email: " + (data.Email ? "‚úì" : "‚úó") + "\n" +
                      "- T√™n ƒëƒÉng nh·∫≠p: " + (data.TenDN ? "‚úì" : "‚úó") + "\n" +
                      "- Th√†nh ph·ªë: " + (data.ThanhPho ? "‚úì" : "‚úó") + "\n" +
                      "- Quy·ªÅn h·∫°n: " + (data.QuyenHan ? "‚úì" : "‚úó"));
                return;
            }

            // Validate quy·ªÅn h·∫°n c·ª• th·ªÉ
            if (!['Qu·∫£n tr·ªã vi√™n', 'Kh√°ch h√†ng'].includes(data.QuyenHan)) {
                alert("‚ùå Quy·ªÅn h·∫°n ph·∫£i l√† 'Qu·∫£n tr·ªã vi√™n' ho·∫∑c 'Kh√°ch h√†ng'");
                return;
            }

            // Validate m·∫≠t kh·∫©u khi th√™m m·ªõi
            if (mode === 'add' && !data.MatKhau) {
                alert("‚ùå Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u khi th√™m ng∆∞·ªùi d√πng m·ªõi");
                return;
            }

            // Validate m·∫≠t kh·∫©u hi·ªán t·∫°i khi s·ª≠a
            if (mode === 'edit' && !data.MatKhauHienTai) {
                alert("‚ùå Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i ƒë·ªÉ x√°c nh·∫≠n");
                return;
            }

            // Validate email
            if (data.Email && !data.Email.includes('@')) {
                alert("‚ùå Email kh√¥ng h·ª£p l·ªá");
                return;
            }

            // Validate phone
            if (data.SoDT && !/^\d{9,11}$/.test(data.SoDT)) {
                alert("‚ùå S·ªë ƒëi·ªán tho·∫°i ph·∫£i t·ª´ 9-11 ch·ªØ s·ªë");
                return;
            }

            try {
                let response;
                let apiUrl;
                
                if (mode === "add") {
                    apiUrl = '../api/user/add_user.php';
                } else {
                    apiUrl = '../api/user/update_user.php';
                }
                
                console.log('Sending request to:', apiUrl);
                console.log('Request data:', JSON.stringify(data, null, 2));
                
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    alert('‚ùå L·ªói ph·∫£n h·ªìi t·ª´ server: ' + responseText);
                    return;
                }
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    closeModal();
                    location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu
                } else {
                    console.error('Server error:', result);
                    alert('‚ùå ' + (result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                }
                
            } catch (error) {
                console.error('Network error:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi server: ' + error.message);
            }
        }

    async function deleteUser(index) {
        const user = window.users[index];
        
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${user.HoTen}"?`)) {
            try {
                const response = await fetch('../api/user/delete_user.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MaND: user.MaND })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu
                } else {
                    alert('‚ùå ' + result.error);
                }
                
            } catch (error) {
                console.error('L·ªói:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi server');
            }
        }
    }

    /* ===== UTILS ===== */
    function showModal() {
        document.getElementById("userModal").classList.remove("hidden");
        document.getElementById("userModal").classList.add("flex");
    }
    function closeModal() {
        document.getElementById("userModal").classList.add("hidden");
    }
    function clearForm() {
        // Reset t·∫•t c·∫£ input fields
        document.querySelectorAll("#userModal input").forEach(i => {
            if (i.type !== 'file') {
                i.value = "";
            }
        });
        
        // Reset t·∫•t c·∫£ select fields
        document.querySelectorAll("#userModal select").forEach(s => {
            s.selectedIndex = 0;
        });
        
        // X√≥a preview avatar
        document.getElementById('avatarPreview').classList.add('hidden');
        document.getElementById('previewImg').src = '';
        document.getElementById('AvatarFile').value = '';
        
        // Reset tr∆∞·ªùng m·∫≠t kh·∫©u hi·ªán t·∫°i
        document.getElementById('MatKhauHienTai').value = '';
        
        console.log('Form cleared');
    }
    
    // X·ª≠ l√Ω preview avatar
    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ùå K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 2MB');
                input.value = '';
                return;
            }
            
            // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Vui l√≤ng ch·ªçn file ·∫£nh (jpg, png, gif...)');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('avatarPreview').classList.remove('hidden');
                
                // L∆∞u base64 v√†o hidden input
                document.getElementById('Avatar').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }
    
    // X√≥a avatar
    function removeAvatar() {
        document.getElementById('AvatarFile').value = '';
        document.getElementById('Avatar').value = '';
        document.getElementById('avatarPreview').classList.add('hidden');
        document.getElementById('previewImg').src = '';
    }
    
    // Hi·ªÉn th·ªã avatar c√≥ s·∫µn khi edit
    function showExistingAvatar(avatarData) {
        if (avatarData && avatarData.trim()) {
            document.getElementById('previewImg').src = avatarData;
            document.getElementById('avatarPreview').classList.remove('hidden');
            document.getElementById('Avatar').value = avatarData;
        } else {
            document.getElementById('avatarPreview').classList.add('hidden');
        }
    }
    function limitPhone(input) {
        input.value = input.value.replace(/\D/g, '');

        if (input.value.length === 1 && input.value[0] !== '0') {
            input.value = '';
            return;
        }

        if (input.value.length > 10) {
            input.value = input.value.slice(0, 10);
        }
    }
    
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    feather.replace();
});
</script>
</body>
</html>
